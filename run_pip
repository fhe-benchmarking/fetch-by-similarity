#!/usr/bin/env bash
# Run script for fetch-by-similarity using pip/python

set -euo pipefail

# Set OpenFHE installation path
export CMAKE_PREFIX_PATH=~/p/openfhe-development/install
export LATTICA_BE_URL=http://localhost:3050
export LATTICA_RUN_MODE=LOCAL

# Get the directory where this script is located
SCRIPT_DIR="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
cd "$SCRIPT_DIR"

# Add repository root to Python path so scripts can import harness and lib modules
export PYTHONPATH="${SCRIPT_DIR}:${PYTHONPATH:-}"

# Check if we're in a virtual environment
if [[ -z "${VIRTUAL_ENV:-}" ]]; then
    echo "Warning: No virtual environment detected!"
fi

# Set torch library path for FHE core (adjust for venv if active)
if [[ -n "${VIRTUAL_ENV:-}" ]]; then
    export LD_LIBRARY_PATH="${VIRTUAL_ENV}/lib/python3.12/site-packages/torch/lib:${LD_LIBRARY_PATH:-}"
else
    # Fallback to system or user site-packages
    PYTHON_SITE=$(python -c "import site; print(site.getsitepackages()[0])")
    export LD_LIBRARY_PATH="${PYTHON_SITE}/torch/lib:${LD_LIBRARY_PATH:-}"
fi

echo "Environment setup complete:"
echo "  CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH"
echo "  Working directory: $(pwd)"
if [[ -n "${VIRTUAL_ENV:-}" ]]; then
    echo "  Virtual environment: $VIRTUAL_ENV"
fi
echo ""

# Check if any arguments provided, default to toy (0) if none
if [ $# -eq 0 ]; then
    echo "No arguments provided, using default: toy dataset (0)"
    set -- 0
fi

# Determine dataset size from first argument
SIZE=$1
case "$SIZE" in
    0) SIZE_NAME="toy" ;;
    1) SIZE_NAME="small" ;;
    2) SIZE_NAME="medium" ;;
    3) SIZE_NAME="large" ;;
    *) SIZE_NAME="" ;;
esac

# Clean up previous test artifacts for this specific size
if [ -n "$SIZE_NAME" ]; then
    echo "Cleaning up previous $SIZE_NAME dataset..."
    rm -rf "datasets/$SIZE_NAME"
    rm -rf "io/$SIZE_NAME"
    echo "Cleanup complete"
    echo ""
fi

echo "Running benchmark with pip/python..."
python harness/run_submission.py "$@"